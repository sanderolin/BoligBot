<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
          http://www.liquibase.org/xml/ns/dbchangelog
          https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="2025-08-10-001-create-housing-tables.xml" author="sanderolin">

        <createTable tableName="cities">
            <column name="id" type="bigserial">
                <constraints primaryKey="true" primaryKeyName="pk_cities" nullable="false"/>
            </column>

            <column name="name" type="varchar(64)">
                <constraints nullable="false" unique="true" uniqueConstraintName="uq_cities_name"/>
            </column>

            <column name="created_at" type="timestamptz">
                <constraints nullable="false"/>
            </column>

            <column name="last_modified_at" type="timestamptz">
                <constraints nullable="false"/>
            </column>

            <column name="last_imported_at" type="timestamptz">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="housing_types">
            <column name="id" type="bigserial">
                <constraints primaryKey="true" primaryKeyName="pk_housing_types" nullable="false"/>
            </column>

            <column name="name" type="text">
                <constraints nullable="false" unique="true" uniqueConstraintName="uq_housing_types_name"/>
            </column>

            <column name="created_at" type="timestamptz">
                <constraints nullable="false"/>
            </column>

            <column name="last_modified_at" type="timestamptz">
                <constraints nullable="false"/>
            </column>

            <column name="last_imported_at" type="timestamptz">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="districts">
            <column name="id" type="bigserial">
                <constraints primaryKey="true" primaryKeyName="pk_districts" nullable="false"/>
            </column>

            <column name="name" type="text">
                <constraints nullable="false"/>
            </column>

            <column name="city_id" type="bigint">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="timestamptz">
                <constraints nullable="false"/>
            </column>

            <column name="last_modified_at" type="timestamptz">
                <constraints nullable="false"/>
            </column>

            <column name="last_imported_at" type="timestamptz">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                constraintName="fk_districts_city"
                baseTableName="districts"
                baseColumnNames="city_id"
                referencedTableName="cities"
                referencedColumnNames="id"
                onDelete="RESTRICT"/>

        <addUniqueConstraint
                tableName="districts"
                columnNames="city_id,name"
                constraintName="uq_districts_city_id_name"/>

        <createIndex tableName="districts" indexName="ix_districts_city_id">
            <column name="city_id"/>
        </createIndex>

        <createTable tableName="housings">

            <column name="rental_object_id" type="text">
                <constraints primaryKey="true" primaryKeyName="pk_housings" nullable="false"/>
            </column>

            <column name="address" type="text">
                <constraints nullable="false"/>
            </column>

            <column name="name" type="text">
                <constraints nullable="false"/>
            </column>

            <column name="housing_type_id" type="bigint">
                <constraints nullable="false"/>
            </column>

            <column name="district_id" type="bigint">
                <constraints nullable="false"/>
            </column>

            <column name="area_sqm" type="numeric(6,2)">
                <constraints nullable="false"/>
            </column>

            <column name="price_per_month" type="integer">
                <constraints nullable="false"/>
            </column>

            <column name="is_available" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>

            <column name="available_from_date" type="date">
                <constraints nullable="true"/>
            </column>

            <column name="created_at" type="timestamptz">
                <constraints nullable="false"/>
            </column>

            <column name="last_modified_at" type="timestamptz">
                <constraints nullable="false"/>
            </column>

            <column name="last_imported_at" type="timestamptz">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                constraintName="fk_housings_housing_type"
                baseTableName="housings"
                baseColumnNames="housing_type_id"
                referencedTableName="housing_types"
                referencedColumnNames="id"
                onDelete="RESTRICT"/>

        <addForeignKeyConstraint
                constraintName="fk_housings_district"
                baseTableName="housings"
                baseColumnNames="district_id"
                referencedTableName="districts"
                referencedColumnNames="id"
                onDelete="RESTRICT"/>

        <createIndex tableName="housings" indexName="ix_housings_district_id">
            <column name="district_id"/>
        </createIndex>

        <createIndex tableName="housings" indexName="ix_housings_housing_type_id">
            <column name="housing_type_id"/>
        </createIndex>

        <createIndex tableName="housings" indexName="ix_housings_is_available">
            <column name="is_available"/>
        </createIndex>

        <createIndex tableName="housings" indexName="ix_housings_price_per_month">
            <column name="price_per_month"/>
        </createIndex>

        <createIndex tableName="housings" indexName="ix_housings_area_sqm">
            <column name="area_sqm"/>
        </createIndex>

        <rollback>
            <dropTable tableName="housings"/>
            <dropTable tableName="districts"/>
            <dropTable tableName="housing_types"/>
            <dropTable tableName="cities"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
